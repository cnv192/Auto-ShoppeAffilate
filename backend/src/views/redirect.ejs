<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- =================================================================
         OPEN GRAPH META TAGS - Hi·ªÉn th·ªã preview tr√™n m·∫°ng x√£ h·ªôi
         ================================================================= -->
    
    <!-- Facebook & General Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="<%= title %>">
    <meta property="og:description" content="Xem ngay deal hot tr√™n Shopee v·ªõi gi√° ∆∞u ƒë√£i ƒë·∫∑c bi·ªát!">
    <meta property="og:image" content="<%= imageUrl %>">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="<%= currentUrl %>">
    <meta property="og:site_name" content="Shopee Deals">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= title %>">
    <meta name="twitter:description" content="Xem ngay deal hot tr√™n Shopee v·ªõi gi√° ∆∞u ƒë√£i ƒë·∫∑c bi·ªát!">
    <meta name="twitter:image" content="<%= imageUrl %>">
    
    <!-- Zalo -->
    <meta property="zalo:official_account_id" content="">
    
    <title><%= title %></title>
    
    <style>
        /* =================================================================
           LOADING ANIMATION STYLES
           Hi·ªÉn th·ªã trong khi ch·ªù redirect
           ================================================================= -->
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #EE4D2D 0%, #FF6B35 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            text-align: center;
            padding: 40px 20px;
            max-width: 400px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .logo svg {
            width: 50px;
            height: 50px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .redirect-info {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        
        .manual-link {
            display: inline-block;
            margin-top: 20px;
            color: white;
            text-decoration: underline;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .manual-link:hover {
            opacity: 1;
        }
        
        /* Hidden iframe for deep link attempt */
        .hidden-iframe {
            display: none;
            width: 0;
            height: 0;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Shopee Logo -->
        <div class="logo">
            <svg viewBox="0 0 192 192" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M96 0C43.065 0 0 43.065 0 96s43.065 96 96 96 96-43.065 96-96S148.935 0 96 0z" fill="#EE4D2D"/>
                <path d="M96 38c-14.36 0-26 11.64-26 26 0 11.847 7.935 21.823 18.78 24.923C77.935 91.823 70 101.8 70 113.647c0 14.36 11.64 26 26 26s26-11.64 26-26c0-11.847-7.935-21.823-18.78-24.923C114.065 85.823 122 75.847 122 64c0-14.36-11.64-26-26-26z" fill="white"/>
            </svg>
        </div>
        
        <!-- Loading Spinner -->
        <div class="spinner"></div>
        
        <!-- Status Messages -->
        <h1 id="status-title">ƒêang chuy·ªÉn h∆∞·ªõng...</h1>
        <p id="status-message">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
        
        <!-- Info Box -->
        <div class="redirect-info">
            <strong><%= title %></strong><br>
            B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn Shopee ngay b√¢y gi·ªù
        </div>
        
        <!-- Manual Link (hi·ªán khi auto-redirect th·∫•t b·∫°i) -->
        <a href="<%= targetUrl %>" class="manual-link" id="manual-link" style="display: none;">
            Nh·∫•n v√†o ƒë√¢y n·∫øu kh√¥ng t·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng
        </a>
    </div>
    
    <!-- Hidden iframe ƒë·ªÉ th·ª≠ m·ªü Deep Link -->
    <iframe id="deep-link-iframe" class="hidden-iframe"></iframe>
    
    <script>
        /**
         * =================================================================
         * DEEP LINK REDIRECT SCRIPT
         * 
         * C∆° ch·∫ø ho·∫°t ƒë·ªông:
         * 1. Ki·ªÉm tra thi·∫øt b·ªã (mobile/desktop)
         * 2. N·∫øu mobile ‚Üí Th·ª≠ m·ªü app Shopee qua Deep Link (shopee://)
         * 3. N·∫øu app kh√¥ng m·ªü ƒë∆∞·ª£c trong 200ms ‚Üí Fallback sang web URL
         * 4. N·∫øu desktop ‚Üí Redirect tr·ª±c ti·∫øp sang web URL
         * =================================================================
         */
        
        (function() {
            'use strict';
            
            // URL ƒë√≠ch t·ª´ Backend
            const targetUrl = '<%= targetUrl %>';
            
            // C√°c element DOM
            const statusTitle = document.getElementById('status-title');
            const statusMessage = document.getElementById('status-message');
            const manualLink = document.getElementById('manual-link');
            const deepLinkIframe = document.getElementById('deep-link-iframe');
            
            /**
             * Ki·ªÉm tra thi·∫øt b·ªã c√≥ ph·∫£i mobile kh√¥ng
             * @returns {boolean}
             */
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i
                    .test(navigator.userAgent);
            }
            
            /**
             * Ki·ªÉm tra h·ªá ƒëi·ªÅu h√†nh
             * @returns {string} - 'ios', 'android', ho·∫∑c 'other'
             */
            function getOS() {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                
                if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    return 'ios';
                }
                
                if (/android/i.test(userAgent)) {
                    return 'android';
                }
                
                return 'other';
            }
            
            /**
             * Chuy·ªÉn ƒë·ªïi URL Shopee web th√†nh Deep Link
             * 
             * V√≠ d·ª•:
             * - https://shopee.vn/product/123 ‚Üí shopee://product/123
             * - https://shopee.vn/flash_sale ‚Üí shopee://flash_sale
             * 
             * @param {string} webUrl - URL web c·ªßa Shopee
             * @returns {string} - Deep Link URL
             */
            function convertToDeepLink(webUrl) {
                try {
                    const url = new URL(webUrl);
                    
                    // L·∫•y path v√† query string
                    const pathAndQuery = url.pathname + url.search;
                    
                    // T·∫°o Deep Link
                    // Format: shopee://[path][query]
                    return 'shopee:/' + pathAndQuery;
                    
                } catch (e) {
                    console.error('Error converting to deep link:', e);
                    return null;
                }
            }
            
            /**
             * Th·ª≠ m·ªü Deep Link s·ª≠ d·ª•ng iframe ·∫©n
             * 
             * C∆° ch·∫ø:
             * - G√°n src c·ªßa iframe th√†nh deep link URL
             * - N·∫øu app ƒë√£ c√†i ‚Üí App s·∫Ω m·ªü v√† handle deep link
             * - N·∫øu app ch∆∞a c√†i ‚Üí Kh√¥ng c√≥ g√¨ x·∫£y ra, s·∫Ω fallback
             * 
             * @param {string} deepLink - Deep Link URL
             */
            function tryDeepLinkViaIframe(deepLink) {
                deepLinkIframe.src = deepLink;
            }
            
            /**
             * Th·ª≠ m·ªü Deep Link s·ª≠ d·ª•ng window.location
             * 
             * Backup method n·∫øu iframe kh√¥ng ho·∫°t ƒë·ªông
             * @param {string} deepLink - Deep Link URL
             */
            function tryDeepLinkViaLocation(deepLink) {
                window.location.href = deepLink;
            }
            
            /**
             * Redirect sang web URL (Fallback)
             */
            function fallbackToWebUrl() {
                statusTitle.textContent = 'ƒêang chuy·ªÉn ƒë·∫øn Shopee...';
                statusMessage.textContent = 'M·ªü tr√¨nh duy·ªát web';
                
                window.location.href = targetUrl;
            }
            
            /**
             * Hi·ªÉn th·ªã link manual khi t·∫•t c·∫£ ph∆∞∆°ng th·ª©c th·∫•t b·∫°i
             */
            function showManualLink() {
                manualLink.style.display = 'inline-block';
            }
            
            /**
             * Main Logic - X·ª≠ l√Ω redirect
             */
            function handleRedirect() {
                console.log('üöÄ Starting redirect process...');
                console.log('üì± Device:', isMobileDevice() ? 'Mobile' : 'Desktop');
                console.log('üíª OS:', getOS());
                console.log('üéØ Target URL:', targetUrl);
                
                // N·∫øu kh√¥ng ph·∫£i mobile ‚Üí Redirect tr·ª±c ti·∫øp
                if (!isMobileDevice()) {
                    console.log('üìç Desktop detected, redirecting to web URL...');
                    statusTitle.textContent = 'ƒêang chuy·ªÉn h∆∞·ªõng...';
                    
                    // Delay nh·∫π ƒë·ªÉ hi·ªán animation
                    setTimeout(fallbackToWebUrl, 500);
                    return;
                }
                
                // Mobile ‚Üí Th·ª≠ Deep Link
                const deepLink = convertToDeepLink(targetUrl);
                console.log('üîó Deep Link:', deepLink);
                
                if (!deepLink) {
                    console.log('‚ùå Failed to generate deep link, using fallback');
                    setTimeout(fallbackToWebUrl, 500);
                    return;
                }
                
                // C·∫≠p nh·∫≠t UI
                statusTitle.textContent = 'ƒêang m·ªü ·ª©ng d·ª•ng Shopee...';
                statusMessage.textContent = 'N·∫øu ƒë√£ c√†i app, Shopee s·∫Ω m·ªü ngay';
                
                // Bi·∫øn theo d√µi tr·∫°ng th√°i
                let appOpened = false;
                
                /**
                 * FALLBACK MECHANISM
                 * 
                 * C√°ch ho·∫°t ƒë·ªông:
                 * 1. Th·ª≠ m·ªü deep link
                 * 2. Set timeout 200ms
                 * 3. N·∫øu app m·ªü ‚Üí User r·ªùi kh·ªèi trang ‚Üí visibilitychange event
                 * 4. N·∫øu app kh√¥ng m·ªü ‚Üí Timeout ch·∫°y ‚Üí Redirect to web
                 * 
                 * T·∫°i sao 200ms?
                 * - ƒê·ªß th·ªùi gian ƒë·ªÉ OS x·ª≠ l√Ω deep link
                 * - Kh√¥ng qu√° l√¢u khi·∫øn user ph·∫£i ch·ªù
                 */
                
                // L·∫Øng nghe s·ª± ki·ªán visibility change
                // Khi app m·ªü, trang web s·∫Ω b·ªã blur/hidden
                const visibilityHandler = function() {
                    if (document.hidden || document.webkitHidden) {
                        appOpened = true;
                        console.log('‚úÖ App opened (visibility changed)');
                    }
                };
                
                document.addEventListener('visibilitychange', visibilityHandler);
                document.addEventListener('webkitvisibilitychange', visibilityHandler);
                
                // L·∫Øng nghe blur event (backup)
                window.addEventListener('blur', function() {
                    appOpened = true;
                    console.log('‚úÖ App opened (window blur)');
                });
                
                // Th·ª≠ m·ªü deep link qua iframe (method 1)
                tryDeepLinkViaIframe(deepLink);
                
                // Fallback timer - 200ms
                const fallbackTimer = setTimeout(function() {
                    // Ki·ªÉm tra n·∫øu app ƒë√£ m·ªü
                    if (appOpened) {
                        console.log('‚úÖ App was opened, no fallback needed');
                        return;
                    }
                    
                    console.log('‚è∞ Timeout reached, trying location method...');
                    
                    // Th·ª≠ method 2: window.location
                    tryDeepLinkViaLocation(deepLink);
                    
                    // Set th√™m 1 timer cho web fallback
                    setTimeout(function() {
                        if (!appOpened && !document.hidden) {
                            console.log('üåê Falling back to web URL');
                            
                            // Cleanup listeners
                            document.removeEventListener('visibilitychange', visibilityHandler);
                            document.removeEventListener('webkitvisibilitychange', visibilityHandler);
                            
                            fallbackToWebUrl();
                        }
                    }, 300); // Th√™m 300ms cho method 2
                    
                }, 200); // 200ms cho method 1
                
                // Hi·ªán manual link sau 2 gi√¢y (safety net)
                setTimeout(showManualLink, 2000);
            }
            
            // B·∫Øt ƒë·∫ßu process khi DOM ready
            if (document.readyState === 'complete') {
                handleRedirect();
            } else {
                window.addEventListener('load', handleRedirect);
            }
            
        })();
    </script>
</body>
</html>
